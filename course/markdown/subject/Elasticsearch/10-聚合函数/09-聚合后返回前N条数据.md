---
title: 09-聚合后返回前N条数据
url: https://www.yuque.com/gaollard/efekv4/iqku4s
---

    # 1. 根据address字段进行聚合
    # 2. 再根据age字段倒序输出，输出每一个地址中age字段值排名前1的数据
    POST /myindex_percentile_ranks/_search?size=0
    {
      // 第一层聚合：先按照address.keyword将数据聚合成多个Bucket（聚合桶）
      "aggs": {
        "top_tags": {
          "terms": {
            "field": "address.keyword" 
          },
          "aggs": {
            "top_sales_hits": {
              // 第二层聚合：在第一层聚合结果中的每个Bucket内进行top_hits操作
              "top_hits": {
                "sort": [
                  {
                    "age": {
                      // 排序条件按照age倒序
                      "order": "desc"
                    }
                  }
                ],
                "_source": {
                  //只返回name和age字段的值
                  "includes": [ "name", "age" ] 
                },
                "size": 1 // 仅返回前1条记录
              }
            }
          }
        }
      }
    }

<!---->

      {
      …
      "aggregations" : {
       …
          "buckets" : [
            {
              "key" : "美国",
              "doc_count" : 3,
               …
                  "hits" : [
                    {
                       …
                      "_source" : {
                        "name" : "李白",
                        "age" : 50
                      },
                      "sort" : [
                        50
                      ]
                    }
                  ]
                }
              }
            },
            {
              "key" : "中国",
              "doc_count" : 2,
              "top_sales_hits" : {
                …
                  "hits" : [
                    {
                      "_index" : "myindex_percentile_ranks",
                      …
                      "_source" : {
                        "name" : "李四",
                        "age" : 20
                      },
                      "sort" : [
                        20
                      ]
                     …
                     ```
