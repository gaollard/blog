---
title: 07-Elasticsearch性能优化详解
url: https://www.yuque.com/gaollard/efekv4/xkev1d
---



### 1. 数据结构优化

基于Elasticsearch的使用场景，文档数据的结构尽量和使用场景相结合，去掉没用的和不合理的数据。下面介绍数据结构优化需要注意的地方。

- 尽量减少不需要的字段
- 尽量使用静态映射, 使用动态映射有可能会导致集群崩溃



### 2. 查询优化

**Cache的设置及使用**

Elasticsearch在查询的时候，使用filter查询会用到querycache，如果业务场景中的过滤查询比较多，建议将querycache设置得大一些，以提高查询速度。设置如下：

    indices.queries.cache.size： 10%

以上设置是默认的，可以设置成百分比，也可以设置成具体的值，如256MB。

**合理使用深度翻页**

在使用 Elasticsearch 的过程中，应尽量避免深度翻页的出现。正常翻页查询都是从from开始size条数据，需要在每个分片中查询文档评分在前面的from+size条数据，然后协同节点收集每个分配的前from+size条数据，协同节点一共会收到N*(from+size)条数据，然后进行排序，再将其中from到from+size条数据返回。如果from或者size很大的话，会导致参加排序的数量过大，最终会导致CPU资源消耗增大。对于这种深度翻页的业务，推荐使用Elasticsearch中的滚动查询来解决。



### 3. 索引优化设置

索引优化主要是在Elasticsearch的数据插入层面优化。下面介绍索引优化设置需要注意的地方。

**合理批量提交**

当有大量数据需要提交时，建议采用批量提交（Bulk操作）的方式。此外，使用Bulk请求时，每个请求的数据量不宜过大，因为太大会导致内存使用过多，尽量控制在几十MB之内。

**增加刷新时间间隔**

为了提高搜索性能，Elasticsearch在写入数据的时候采用延迟写入的策略，即数据先写到内存中，当超过默认的1秒（index.refresh\_interval）后会进行一次写入操作，就是将内存中的段数据刷新到磁盘中，此时才能将数据搜索出来，所以这就是Elasticsearch提供的是近实时搜索功能，而不是实时搜索功能的原因。如果系统对数据延迟要求不高的话，可以通过延长刷新时间间隔来有效地减少段合并的压力，提高索引的性能。比如在做全链路日志跟踪的过程中，我们就将index.refresh\_interval设置为30秒，减少刷新次数。再如，在进行数据导入时，可以将“刷新”临时关闭，即把index.refresh\_interval设置为设1，数据导入成功后再打开为正常模式。

**注意\_id字段的使用**

在创建索引或者写入文档数据时，应该尽可能避免使用自定义的\_id，建议使用Elasticsearch的默认ID生成策略，这样对于Elasticsearch内部进行数据负载有很大作用。

**注意\_all和\_source字段的使用**

\_all和\_source字段的使用应该注意场景和需要，\_all字段包含所有的索引字段，方便做全文搜索，如果无此需求，可以禁用；\_source存储了原始的文档内容，如果没有获取原始文档数据的需求，可通过设置includes、excludes属性来定义放入\_source的字段。



### 4. 硬件配置优化

升级硬件设备的配置一直都是提高服务能力最快速有效的手段之一。在系统层面能够影响应用性能的因素一般有3个：CPU、内存和IO，可以从这3个方面对Elasticsearch的性能进行优化。下面介绍硬件配置优化方面需要注意的地方。

**磁盘的选择**

硬盘对所有的集群都很重要，对大量写入数据的集群更是加倍重要。硬盘是服务器上最慢的子系统，这意味着那些写入量很大的集群很容易让硬盘饱和，使得它成为集群的瓶颈。在经济压力能承受的范围内，尽量使用固态硬盘（Solid StateDrive，SSD）。固态硬盘相比任何旋转介质，无论是随机写还是顺序写，都会对IO有较大的提升。

**禁止swap**

在使用Elasticsearch的时候，推荐做法是禁用swap，一旦允许内存与磁盘交换，就会引起致命的性能问题。可以通过在config/elasticsearch.yml配置文件中修改bootstrap.memory\_lock: true来保持JVM锁定内存，以保证Elasticsearch的性能。

**内存配置**

在Elasticsearch中，排序和聚合都很耗内存，所以有足够的堆空间来应付它们是很重要的。即使堆空间比较小，也能为操作系统文件缓存提供额外的内存。因为Lucene使用的许多数据结构都是基于磁盘的格式，Elasticsearch利用操作系统缓存对性能的提升能产生很大的效果。如果机器内存等于64GB，可以给Elasticsearch分配32GB，留下32GB给Lucene。当服务内存是32GB和16GB时，最少也需要给Elasticsearch分配8GB。
