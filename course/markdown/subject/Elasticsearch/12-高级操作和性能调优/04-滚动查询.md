---
title: 04-滚动查询
url: https://www.yuque.com/gaollard/efekv4/qp076g
---

当索引库中数据量特别大的时候，`深度分页的操作` 会给Elasticsearch集群的性能带来极大损耗。为了解决这个问题，Elasticsearch提供了滚动查询来避免这种情况。范例如下：

    #创建索引库并指定映射关系
    PUT scrolldb
    {
      "mappings" : {
        "properties" : {
          "name" : {
            "type" : "keyword"
          },
          "age" : {
            "type" : "integer"
          }
        }
      }
    }

    #批量新增数据
    POST _bulk
    { "index" : { "_index" : "scrolldb", "_id" : "1" } }
    { "name" : "张三", "age": 12}
    { "index" : { "_index" : "scrolldb", "_id" : "2" } }
    { "name" : "李四", "age": 10 }
    { "index" : { "_index" : "scrolldb", "_id" : "3" } }
    { "name" : "王五", "age": 11 }
    { "index" : { "_index" : "scrolldb", "_id" : "4" } }

    #滚动查询，每次查询返回2条文档，并且数据量不能超过1MB，也就是说当一条文档信息超过1MB的时候，只会返回1条文档信息
    POST /scrolldb/_search?scroll=1m
    {
        "size": 2,
        "query": {
            "match_all": {
                   
            }
        }
    }

结果：

    {
      #下次进行滚动查询需要带的标识
      "_scroll_id" : "FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFjZnWUJ1RTJYUmZhTzhCMVNUemNIX2cAAAAAAAFmQxZ5UWdMX25LNlJYR1JMeHltWlhkcVVR",
      "took" : 4,
      "timed_out" : false,
      "_shards" : {
        "total" : 1,
        "successful" : 1,
        "skipped" : 0,
        "failed" : 0
      },
      "hits" : {
        "total" : {
          "value" : 3,
          "relation" : "eq"
        },
        "max_score" : 1.0,
        "hits" : [
          {
            "_index" : "scrolldb",
            "_type" : "_doc",
            "_id" : "1",
            "_score" : 1.0,
            "_source" : {
              "name" : "张三",
              "age" : 12
            }
          },
          {
            "_index" : "scrolldb",
            "_type" : "_doc",
            "_id" : "2",
            "_score" : 1.0,
            "_source" : {
              "name" : "李四",
              "age" : 10
            }
          }
        ]
      }
    }
    #使用滚动查询返回信息的scroll_id继续查询，直到查不出为止，一般情况下当查询结果数量小于第一次查询执行的size时，结束查询
    POST /_search/scroll 
    {
        "scroll" : "1m", 
        "scroll_id" : " FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFjZnWUJ1RTJYUmZhTzhCMVNUemNIX2cAAAAAAAFmQxZ5UWdMX25LNlJYR1JMeHltWlhkcVVR " 
    }
