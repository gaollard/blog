---
title: 09-数据存储段合并详情
url: https://www.yuque.com/gaollard/efekv4/phxgsz
---

当客户端写入数据时，同时把数据写入translog日志（防止服务重启导致内存数据库丢失）和索引缓存（index buffer）中。在用户读取数据的时候，读取的是“段”中的数据。在Elasticsearch中，写入和打开一个新段（Segment）的过程叫作刷新（Refresh）。

Elasticsearch数据写入流程: ![](https://s3.airtlab.com/elasticsearch/20220430214729.png)

在默认情况下，每个分片每秒会自动刷新一次。这就是我们说 Elasticsearch 是近实时搜索引擎的原因（`文档的变化并不是立即对搜索可见，但会在一秒之内变为可见`）。每个数据分片是由很多段组成的，每个段都需要占用内存等资源。

为了提高性能，Elasticsearch会定期将小的段进行合并，生成较大的段。由于自动刷新流程每秒会创建一个新的段，这样会导致短时间内段的数量暴增。而段的数量太多会带来比较大的麻烦，因为每一个段都会消耗IO、内存和CPU等资源。更重要的是，每个搜索请求都必须轮流检查每个段，所以段越多，搜索也就越慢。Elasticsearch通过在后台进行段合并来解决这个问题。小的段被合并到大的段里面，然后这些大的段再被合并到更大的段里面。当段合并的时候，会将那些旧的已删除的文档从文件系统中清除。旧的文档（或被更新文档的旧版本）不会被复制到新的大段中去。以下是段相关的一些操作：

1）当写入索引数据的时候，刷新操作会创建新的段并且将段的状态设置为打开以供搜索使用。

2）段合并的时候会选择一小部分大小相似的段，并且在后台将它们合并到更大的段中。

3）段合并结束时，旧的段中的数据会被删除。

刷新操作并不需要每秒进行一次。如果有业务正在使用Elasticsearch索引中大量的日志文件，此时用户想要优化数据写入性能，可以通过设置refresh\_interval参数进行优化，以降低索引的刷新频率，提高数据写入的性能。语法如下：

    #设置时间时间为30秒，表示每30秒进行一次刷新
    PUT /索引库名称
    {
      "settings": {
        "refresh_interval": "30s"
      }
    }

    #关闭自动刷新操作
    PUT /索引库名称/_settings
    { "refresh_interval": -1 }

    #开启刷新且刷新时间为1秒
    PUT /索引库名称/_settings
    { "refresh_interval": "1s" }
