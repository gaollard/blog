---
title: 03-动态映射
url: https://www.yuque.com/gaollard/efekv4/cugcsc
---



### 1. 动态映射

使用动态映射在写入索引文档数据时，不需要先创建索引和定义字段。索引中的字段和字段类型都将自动创建。

`Elasticsearch` 在用户写入数据时检测到新的字段时，会动态地将该字段添加到类型映射中，由 `dynamic` 参数来控制此行为。



### 2. 动态模式 dynamic: true

根据输入文档的内容，自动推断字段和类型，创建 mapping。

```shell
# 假设不存 test_04 索引
POST /test_04/_doc
{
  "name": "hi"
}

# 获取索引信息
GET /test_04
{
  "test_04" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "name" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    },
    # 省略
    "settings" : {}
  }
}
```



### 3. 非动态模式 dynamic: false

无法根据输入文档的内容自动创建 mapping，需要手动创建 mapping。

```shell
# 假设不存 test_05 索引
PUT test_05
{
 "mappings": {
   "dynamic": false,
   "properties": {
      "name": {
        "type" : "text",
        "fields" : {
          "keyword" : {
            "type" : "keyword",
            "ignore_above" : 256
          }
        }
      }
   }
 }
}

GET /test_05
{
  "test_05" : {
    "aliases" : { },
    "mappings" : {
      "dynamic" : "false",
      "properties" : {
        "name" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    },
    "settings" : {}
  }
}
```

如果有字段不在mapping中，依然可以存储和读取，但是该字段不在mapping中，因此也无法根据该字段进行检索。



### 3. 严格模式 dynamic:strict

类似非动态模式，如果有字段不在mapping中，无法存储，会直接报错，严格模式实际上就类似于关系型数据库中的表了；

```shell
# 假设不存 test_06 索引
PUT test_06
{
 "mappings": {
   "dynamic": "strict",
   "properties": {
      "name": {
        "type" : "text",
        "fields" : {
          "keyword" : {
            "type" : "keyword",
            "ignore_above" : 256
          }
        }
      }
   }
 }
}

GET /test_06
{
  "test_06" : {
    "aliases" : { },
    "mappings" : {
      "dynamic" : "strict",
      "properties" : {
        "name" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    },
  }
}
```

```shell
POST /test_06/_doc
{
  "name": "hi",
  "wife": "world"
}

# 无法插入
{
  "error": {
    "root_cause": [
      {
        "type": "strict_dynamic_mapping_exception",
        "reason": "mapping set to strict, dynamic introduction of [wife] within [_doc] is not allowed"
      }
    ],
    "type": "strict_dynamic_mapping_exception",
    "reason": "mapping set to strict, dynamic introduction of [wife] within [_doc] is not allowed"
  },
  "status": 400
}
```



#### 日期检测

启用date\_detection选项（默认启用），在检查新添加的字符串字段内容是否与指定的任何日期模式匹配时，如果找到匹配项，则会添加一个具有date格式的新字段。

如果想要禁用日期检测，把date\_detection参数设置为false即可：

```shell
PUT myindex
{
  "mappings": {
    "date_detection": false
  }
}
```

禁用日期检测后，如果插入的数据为日期格式，那么其类型是text，而子类型是keyword。



#### 数字检测

```shell
#创建映射并使用数字检测模式
PUT myindex
{
  "mappings": {
    "numeric_detection": true
  }
}

#添加文档数据（默认使用动态映射）
PUT myindex/_doc/1
{
  "my_float":   "1.0", 
  "my_integer": "1" 
}

#查询映射信息
GET myindex/_mapping
{
  "myindex" : {
    "mappings" : {
      "numeric_detection" : true,
      "properties" : {
        "my_float" : {
          "type" : "float"
        },
        "my_integer" : {
          "type" : "long"
        }
      }
    }
  }
}
```

在没有开启数字检测模式时，无论是字段的父类型，还是子类型，都不会被映射为数字类型。
