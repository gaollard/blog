---
title: 02-锁测试
---

### 1、行锁测试

#### 1. 行锁分析

```sql
show status like 'innodb_row_lock%';
```

![image.png](http://s3.airtlab.com/mysql/1661853567939-ef25e55f-c9d6-4fb1-93cb-5ad3b0c7d4b4.png)

```sql
1. innodb_row_lock_current_waits // 当前正在等待锁定的数量
2. innodb_row_lock_time // 从系统启动到现在锁定总时间长度
3. innodb_row_lock_time_avg // 每次等待所花平均时间
4. innodb_row_lock_time_max // 从系统启动到现在等待最长的一次所花时间
5. innodb_row_lock_waits // 系统启动后到现在总共等待的次数
```



#### 2.  读锁测试

![image.png](http://s3.airtlab.com/mysql/1661917312810-80b15df5-0e01-4878-93c6-a134dcfbe215.png) 

#### 3. 写锁测试

![image.png](http://s3.airtlab.com/mysql/1661917475949-8764df23-bd92-43b0-978e-64fb78723f13.png)



### 2、表锁测试



#### 1. 查询是否锁表

```sql
SHOW OPEN TABLES;

show OPEN TABLES where In_use > 0;
```

![image.png](http://s3.airtlab.com/mysql/1661853872258-24d64fb2-0cf8-4e1e-a40b-78cd94a90f49.png) 

#### 2. **锁表 & 解锁**

```sql
# 锁定数据表，避免在备份过程中，表被更新

mysql>LOCK TABLES tbl_name READ;

# 为表增加一个写锁定：

mysql>LOCK TABLES tbl_name WRITE;

# 解锁
UNLOCK TABLES;
```



#### 3. 查询表锁争用情况

```sql
SHOW STATUS LIKE 'table%';
```

![image.png](http://s3.airtlab.com/mysql/1661853050613-eba3597b-5810-4fbd-9ce4-fcd5c4984ecb.png)

- table\_locks\_immediate : 可以立即获取锁的次数
- table\_locks\_waited : 不能立即获取锁，需要等待锁的次数 (每等待一次值加1） 

#### 4. 读锁测试

![image.png](http://s3.airtlab.com/mysql/1661854262277-7d98c1c4-faed-43b2-8bad-506db28fa352.png) 

#### 5. 写锁测试

场景：数据迁移，目标表加写锁，原表既可以读锁又可以写锁，但是读锁更好
![image.png](http://s3.airtlab.com/mysql/1661854343954-c391dda8-f866-4c9e-b44a-46ac7cae5120.png)
